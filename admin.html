// 1. 頁面載入：從雲端獲取所有 GPX 清單與開關狀態
window.onload = async function() {
    const status = document.getElementById('upload-status');
    status.innerText = '正在同步雲端清單...';

    try {
        // 使用 doGet 獲取資料
        const response = await fetch(GAS_URL);
        const data = await response.json();

        // 更新開關狀態
        document.getElementById('enable-line').checked = data.line;
        document.getElementById('enable-tg').checked = data.telegram;

        // 更新 GPX 選單
        const select = document.getElementById('gpx-list');
        select.innerHTML = ''; // 清空舊的
        data.gpxFiles.forEach(file => {
            const opt = document.createElement('option');
            opt.value = file;
            opt.text = file;
            select.add(opt);
        });

        // 恢復上次選擇的標記
        const lastSelected = localStorage.getItem('selectedGPX');
        if (lastSelected) select.value = lastSelected;
        document.getElementById('current-gpx').innerText = select.value;

        status.innerText = '✅ 雲端同步完成';
        status.style.color = 'green';
    } catch (e) {
        status.innerText = '⚠️ 無法從雲端同步清單';
    }
};

// 2. 上傳新 GPX 並永久儲存到雲端
async function uploadGpx() {
    const fileInput = document.getElementById('gpx-file');
    const status = document.getElementById('upload-status');
    if (fileInput.files.length === 0) return alert('請先選擇 .gpx 檔案');
    
    const fileName = fileInput.files[0].name;
    status.innerText = '正在保存檔名到雲端...';

    try {
        // 通知 GAS 紀錄這個新檔名
        await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                type: 'saveGpxName',
                fileName: fileName
            })
        });

        // 更新本地選單
        const select = document.getElementById('gpx-list');
        const opt = document.createElement('option');
        opt.value = fileName; opt.text = fileName;
        select.add(opt);
        select.value = fileName;
        
        changeGpx(fileName);
        status.innerText = '✅ 已永久保存並切換至：' + fileName;
        status.style.color = 'green';
    } catch (e) {
        status.innerText = '❌ 保存失敗';
    }
}
