// 1. 初始化地圖
const map = L.map('map').setView([23.5, 121], 7);

// 2. 底圖設定
const rudyMap = L.tileLayer('https://tile.happyman.idv.tw/map/is_rudy/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '魯地圖 (Rudy Map)'
}).addTo(map);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
});

const baseMaps = {
    "魯地圖 (Rudy)": rudyMap,
    "標準地圖 (OSM)": osm
};
L.control.layers(baseMaps).addTo(map);

// 3. 載入 GPX 計畫路徑 (檔名需為 route.gpx)
const gpxUrl = 'route.gpx'; 
new L.GPX(gpxUrl, {
    async: true,
    marker_options: {
        startIconUrl: 'https://cdn.jsdelivr.net/gh/mpetazzoni/leaflet-gpx@master/pin-icon-start.png',
        endIconUrl: 'https://cdn.jsdelivr.net/gh/mpetazzoni/leaflet-gpx@master/pin-icon-end.png',
        shadowUrl: 'https://cdn.jsdelivr.net/gh/mpetazzoni/leaflet-gpx@master/pin-shadow.png'
    },
    polyline_options: { color: '#0033ff', weight: 4, opacity: 0.7 }
}).on('loaded', function(e) {
    map.fitBounds(e.target.getBounds()); 
}).on('error', function(e) {
    console.warn('GPX 載入失敗，請確認檔案是否存在。');
}).addTo(map);

// 4. 定時抓取所有位置記錄
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1MrdXtkY7rISADs_7Wgsde5LNWN9OWVIzNKSi92auyKU/export?format=csv"; 

let currentMarker;       // 最新位置的大標記
let historyPath;         // 歷史軌跡線 (虛線)
let historyMarkers = L.layerGroup().addTo(map); // 存放所有歷史點的圖層
let lastPos = [0, 0];

async function fetchLatestLocation() {
    try {
        if (!SHEET_CSV_URL) return;

        const response = await fetch(SHEET_CSV_URL);
        const csvData = await response.text();
        
        // 分割行並過濾掉空白行
        const rows = csvData.trim().split('\n').filter(row => row.trim() !== "");
        if (rows.length <= 1) return; 

        const pathCoords = []; 
        historyMarkers.clearLayers(); 

        // 遍歷所有行 (跳過第一行標題)
        rows.forEach((row, index) => {
            if (index === 0) return;
            const cols = row.split(',');
            const time = cols[0];
            const lat = parseFloat(cols[1]);
            const lng = parseFloat(cols[2]);
            const msg = cols[3] || "無訊息";

            if (!isNaN(lat) && !isNaN(lng)) {
                const pos = [lat, lng];
                pathCoords.push(pos);

                // 在每個回報點畫一個橘色小圓點
                const marker = L.circleMarker(pos, {
                    radius: 5,
                    color: '#ff4400',
                    fillColor: '#ff4400',
                    fillOpacity: 0.8
                }).bindPopup(`<b>時間:</b> ${time}<br><b>訊息:</b> ${msg}`);
                
                historyMarkers.addLayer(marker);
            }
        });

        // 更新歷史軌跡線 (虛線)
        if (historyPath) {
            historyPath.setLatLngs(pathCoords);
        } else {
            historyPath = L.polyline(pathCoords, {
                color: '#ff4400',
                weight: 3,
                opacity: 0.6,
                dashArray: '5, 10'
            }).addTo(map);
        }

        // 處理最新的位置 (最後一筆有效資料)
        if (pathCoords.length > 0) {
            lastPos = pathCoords[pathCoords.length - 1];
            const lastRow = rows[rows.length - 1].split(',');
            
            if (currentMarker) {
                currentMarker.setLatLng(lastPos);
            } else {
                currentMarker = L.marker(lastPos).addTo(map).bindPopup("<b>最新位置</b>");
            }

            // 更新資訊面板
            document.getElementById('last-time').innerText = lastRow[0];
            document.getElementById('last-coord').innerText = `${lastPos[0].toFixed(5)}, ${lastPos[1].toFixed(5)}`;
            document.getElementById('last-msg').innerText = lastRow[3] || "無訊息";
        }

    } catch (error) {
        console.error('從 Google Sheets 讀取資料失敗:', error);
    }
}

function zoomToCurrent() {
    if (lastPos[0] !== 0) map.setView(lastPos, 16);
}

// 每 5 分鐘自動重新抓取 (300,000 毫秒)
setInterval(fetchLatestLocation, 300000);
fetchLatestLocation();
